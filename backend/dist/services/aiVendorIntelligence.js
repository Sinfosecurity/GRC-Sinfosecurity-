"use strict";
/**
 * AI-Powered Vendor Intelligence Service
 * Advanced AI features for TPRM including contract analysis, risk prediction, and audit readiness
 */
Object.defineProperty(exports, "__esModule", { value: true });
class AIVendorIntelligenceService {
    /**
     * Generate AI-powered vendor risk summary
     */
    async generateVendorRiskSummary(vendorData) {
        const summary = `
## Vendor Risk Analysis: ${vendorData.name}

**Overall Risk Score:** ${vendorData.residualRiskScore}/100 (${this.getRiskLevel(vendorData.residualRiskScore)})

**Risk Tier:** ${vendorData.tier}

### Key Risk Factors:
${this.analyzeRiskFactors(vendorData)}

### Data Exposure:
- **Data Types Accessed:** ${vendorData.dataTypesAccessed.join(', ')}
- **Geographic Footprint:** ${vendorData.geographicFootprint.join(', ')}
- **Regulatory Scope:** ${vendorData.regulatoryScope.join(', ')}

### Assessment Status:
- **Last Assessment:** ${vendorData.lastReviewDate || 'Never'}
- **Next Review Due:** ${vendorData.nextReviewDate || 'Not scheduled'}

### Open Issues: ${vendorData._count?.issues || 0}

### AI Recommendations:
${await this.generateRecommendations(vendorData)}

---
*This summary was generated by AI-powered risk analysis. Review recommendations with your compliance team.*
        `.trim();
        return summary;
    }
    /**
     * Analyze vendor assessment responses using AI
     */
    async analyzeAssessmentResponses(assessmentData) {
        const weakResponses = assessmentData.responses.filter((r) => r.score && r.score < 6);
        const flaggedItems = [];
        for (const response of weakResponses) {
            const analysis = {
                questionId: response.questionId,
                question: response.questionText,
                response: response.response,
                score: response.score,
                concerns: [],
                recommendations: [],
            };
            // AI-powered response analysis
            if (response.response?.toLowerCase().includes('no') ||
                response.response?.toLowerCase().includes('unknown')) {
                analysis.concerns.push('Vendor lacks this control or cannot confirm implementation');
            }
            if (response.questionCategory === 'Security' && response.score < 5) {
                analysis.concerns.push('Critical security control gap identified');
                analysis.recommendations.push('Request detailed security documentation and implementation plan');
            }
            if (response.questionCategory === 'Privacy' && response.score < 5) {
                analysis.concerns.push('Privacy compliance concern');
                analysis.recommendations.push('Review Data Processing Agreement and obtain legal approval');
            }
            if (!response.hasEvidence && response.evidenceRequired) {
                analysis.concerns.push('Missing required evidence');
                analysis.recommendations.push('Request supporting documentation before approval');
            }
            if (analysis.concerns.length > 0) {
                flaggedItems.push(analysis);
            }
        }
        return {
            totalResponses: assessmentData.responses.length,
            weakResponses: weakResponses.length,
            flaggedItems,
            overallRisk: this.calculateOverallRisk(assessmentData.responses),
            recommendation: this.generateAssessmentRecommendation(flaggedItems.length, assessmentData.responses.length),
        };
    }
    /**
     * AI Contract Clause Review
     */
    async reviewContractClauses(contractText, vendorName) {
        const analysis = {
            contractName: vendorName,
            overallRiskScore: 0,
            missingClauses: [],
            weakClauses: [],
            strongClauses: [],
            recommendations: [],
        };
        // Critical clause checks
        const criticalClauses = [
            {
                name: 'Data Protection & Security',
                keywords: ['data protection', 'security', 'encryption', 'confidentiality'],
                importance: 'Critical',
            },
            {
                name: 'Right to Audit',
                keywords: ['audit', 'inspection', 'right to audit', 'assessment rights'],
                importance: 'High',
            },
            {
                name: 'Breach Notification',
                keywords: ['breach', 'incident notification', 'security incident', 'data breach'],
                importance: 'Critical',
            },
            {
                name: 'Data Processing Agreement (GDPR)',
                keywords: ['data processing', 'gdpr', 'data processor', 'controller'],
                importance: 'Critical',
            },
            {
                name: 'Liability & Indemnification',
                keywords: ['liability', 'indemnify', 'indemnification', 'damages'],
                importance: 'High',
            },
            {
                name: 'Termination Rights',
                keywords: ['termination', 'cancellation', 'exit', 'wind down'],
                importance: 'Medium',
            },
            {
                name: 'Service Level Agreements',
                keywords: ['sla', 'service level', 'uptime', 'availability'],
                importance: 'High',
            },
            {
                name: 'Subcontractor Controls',
                keywords: ['subcontractor', 'sub-processor', 'third party', 'vendor'],
                importance: 'Medium',
            },
            {
                name: 'Insurance Requirements',
                keywords: ['insurance', 'cyber insurance', 'coverage', 'policy'],
                importance: 'Medium',
            },
        ];
        const lowerText = contractText.toLowerCase();
        let riskScore = 0;
        for (const clause of criticalClauses) {
            const found = clause.keywords.some(keyword => lowerText.includes(keyword));
            if (!found) {
                analysis.missingClauses.push({
                    clause: clause.name,
                    importance: clause.importance,
                    riskImpact: this.getClauseRiskImpact(clause.importance),
                });
                if (clause.importance === 'Critical')
                    riskScore += 20;
                else if (clause.importance === 'High')
                    riskScore += 10;
                else
                    riskScore += 5;
            }
            else {
                analysis.strongClauses.push({
                    clause: clause.name,
                    status: 'Present',
                });
            }
        }
        analysis.overallRiskScore = Math.min(riskScore, 100);
        // Generate recommendations
        for (const missing of analysis.missingClauses) {
            analysis.recommendations.push({
                title: `Add ${missing.clause}`,
                description: `Include comprehensive ${missing.clause.toLowerCase()} clause to mitigate ${missing.riskImpact}`,
                priority: missing.importance,
                suggestedLanguage: this.getSuggestedClauseLanguage(missing.clause),
            });
        }
        return analysis;
    }
    /**
     * AI Audit Readiness - Generate vendor audit package
     */
    async generateVendorAuditPackage(vendorId, organizationId) {
        // This would gather all vendor data and generate comprehensive audit documentation
        const auditPackage = {
            vendorId,
            generatedAt: new Date().toISOString(),
            sections: [
                {
                    title: 'Vendor Overview',
                    status: 'complete',
                    items: [
                        'Vendor profile and contact information',
                        'Services provided and criticality assessment',
                        'Contract details and SLA commitments',
                    ],
                },
                {
                    title: 'Risk Assessment',
                    status: 'complete',
                    items: [
                        'Initial and current risk scores',
                        'Risk tier justification',
                        'Assessment history and results',
                        'Identified risks and mitigation plans',
                    ],
                },
                {
                    title: 'Due Diligence Documentation',
                    status: 'complete',
                    items: [
                        'Completed questionnaires (SIG, CAIQ, etc.)',
                        'SOC 2 / ISO 27001 certifications',
                        'Security policies and procedures',
                        'Business continuity plans',
                        'Insurance certificates',
                    ],
                },
                {
                    title: 'Ongoing Monitoring',
                    status: 'complete',
                    items: [
                        'Continuous monitoring activities',
                        'SLA performance metrics',
                        'Security rating trends',
                        'Incident history',
                    ],
                },
                {
                    title: 'Issue Management',
                    status: 'complete',
                    items: [
                        'Open issues and remediation plans',
                        'Closed issues and validation evidence',
                        'Risk acceptance documentation',
                    ],
                },
                {
                    title: 'Compliance Evidence',
                    status: 'complete',
                    items: [
                        'Regulatory compliance mappings',
                        'Data protection agreements',
                        'Audit rights documentation',
                    ],
                },
            ],
            narratives: {
                executiveSummary: await this.generateAuditNarrative('executive', vendorId),
                riskSummary: await this.generateAuditNarrative('risk', vendorId),
                complianceSummary: await this.generateAuditNarrative('compliance', vendorId),
            },
            gaps: [],
            recommendations: [],
        };
        return auditPackage;
    }
    /**
     * Natural Language Q&A for vendors
     */
    async answerVendorQuestion(question, vendorContext) {
        const lowerQuestion = question.toLowerCase();
        if (lowerQuestion.includes('high risk') || lowerQuestion.includes('critical')) {
            // Query for high risk vendors
            return `Based on the current vendor portfolio, there are ${vendorContext.highRiskCount || 0} high-risk vendors and ${vendorContext.criticalCount || 0} critical vendors. These vendors require quarterly assessments and enhanced monitoring.`;
        }
        if (lowerQuestion.includes('overdue')) {
            return `There are ${vendorContext.overdueCount || 0} vendors with overdue reviews. Critical and high-tier vendors should be prioritized for immediate reassessment.`;
        }
        if (lowerQuestion.includes('compliance') || lowerQuestion.includes('compliant')) {
            return `Average vendor compliance score is ${vendorContext.avgComplianceScore || 0}%. ${vendorContext.nonCompliantCount || 0} vendors have compliance scores below 70% and require attention.`;
        }
        if (lowerQuestion.includes('issue') || lowerQuestion.includes('problem')) {
            return `There are ${vendorContext.openIssuesCount || 0} open vendor issues, with ${vendorContext.criticalIssuesCount || 0} classified as critical. Average remediation time is ${vendorContext.avgRemediationDays || 0} days.`;
        }
        return `I can help you with vendor risk analysis. Try asking about high-risk vendors, overdue assessments, compliance status, or open issues.`;
    }
    /**
     * Vendor Risk Comparison
     */
    async compareVendors(vendor1Data, vendor2Data) {
        return {
            comparison: [
                {
                    metric: 'Overall Risk Score',
                    vendor1: vendor1Data.residualRiskScore,
                    vendor2: vendor2Data.residualRiskScore,
                    winner: vendor1Data.residualRiskScore < vendor2Data.residualRiskScore ? 'vendor1' : 'vendor2',
                },
                {
                    metric: 'Risk Tier',
                    vendor1: vendor1Data.tier,
                    vendor2: vendor2Data.tier,
                    winner: this.compareTiers(vendor1Data.tier, vendor2Data.tier),
                },
                {
                    metric: 'Last Assessment',
                    vendor1: vendor1Data.lastReviewDate,
                    vendor2: vendor2Data.lastReviewDate,
                    winner: new Date(vendor1Data.lastReviewDate) > new Date(vendor2Data.lastReviewDate) ? 'vendor1' : 'vendor2',
                },
                {
                    metric: 'Open Issues',
                    vendor1: vendor1Data._count?.issues || 0,
                    vendor2: vendor2Data._count?.issues || 0,
                    winner: (vendor1Data._count?.issues || 0) < (vendor2Data._count?.issues || 0) ? 'vendor1' : 'vendor2',
                },
            ],
            recommendation: this.generateComparisonRecommendation(vendor1Data, vendor2Data),
        };
    }
    // ==========================================
    // PRIVATE HELPER METHODS
    // ==========================================
    getRiskLevel(score) {
        if (score >= 80)
            return 'Critical';
        if (score >= 60)
            return 'High';
        if (score >= 30)
            return 'Medium';
        return 'Low';
    }
    analyzeRiskFactors(vendor) {
        const factors = [];
        if (vendor.tier === 'CRITICAL') {
            factors.push('- **Critical vendor classification** - Business-critical services');
        }
        if (vendor.dataTypesAccessed?.includes('PII') || vendor.dataTypesAccessed?.includes('PHI')) {
            factors.push('- **Sensitive data access** - Processes PII/PHI requiring enhanced controls');
        }
        if (vendor.hasSubcontractors) {
            factors.push('- **Fourth-party risk** - Uses subcontractors, increasing supply chain risk');
        }
        if (vendor.regulatoryScope?.length > 0) {
            factors.push(`- **Regulatory scope** - Subject to ${vendor.regulatoryScope.join(', ')}`);
        }
        return factors.length > 0 ? factors.join('\n') : '- No significant risk factors identified';
    }
    async generateRecommendations(vendor) {
        const recommendations = [];
        if (!vendor.lastReviewDate) {
            recommendations.push('- **Immediate action:** Conduct initial due diligence assessment');
        }
        if (vendor.residualRiskScore > 70) {
            recommendations.push('- **High priority:** Implement additional controls or consider alternative vendors');
        }
        if (vendor._count?.issues > 0) {
            recommendations.push(`- **Action required:** Resolve ${vendor._count.issues} open issues before contract renewal`);
        }
        return recommendations.length > 0 ? recommendations.join('\n') : '- No immediate recommendations';
    }
    calculateOverallRisk(responses) {
        const avgScore = responses.reduce((sum, r) => sum + (r.score || 0), 0) / responses.length;
        const riskScore = 100 - (avgScore / 10) * 100;
        if (riskScore > 70)
            return 'High Risk - Not recommended for engagement';
        if (riskScore > 40)
            return 'Medium Risk - Approved with enhanced monitoring';
        return 'Low Risk - Approved for engagement';
    }
    generateAssessmentRecommendation(flaggedCount, totalCount) {
        const flaggedPercentage = (flaggedCount / totalCount) * 100;
        if (flaggedPercentage > 30) {
            return 'High risk - recommend rejecting or requiring significant improvements before engagement';
        }
        else if (flaggedPercentage > 15) {
            return 'Medium risk - approve with enhanced monitoring and corrective action plan';
        }
        else {
            return 'Low risk - approve for engagement with standard monitoring';
        }
    }
    getClauseRiskImpact(importance) {
        if (importance === 'Critical')
            return 'critical security/compliance risks';
        if (importance === 'High')
            return 'significant operational and legal risks';
        return 'moderate contractual risks';
    }
    getSuggestedClauseLanguage(clauseName) {
        const templates = {
            'Data Protection & Security': 'Vendor shall implement industry-standard security controls including encryption at rest and in transit, access controls, and regular security assessments...',
            'Right to Audit': 'Client reserves the right to audit Vendor\'s security controls and compliance with this Agreement upon reasonable notice...',
            'Breach Notification': 'Vendor shall notify Client within 24 hours of discovering any security incident that affects Client data...',
            'Data Processing Agreement (GDPR)': 'Vendor agrees to process personal data only in accordance with GDPR requirements and documented instructions from Client...',
        };
        return templates[clauseName] || 'Standard contractual language recommended';
    }
    async generateAuditNarrative(type, vendorId) {
        // Generate AI-powered audit narrative
        if (type === 'executive') {
            return 'This vendor has undergone comprehensive third-party risk assessment. All required due diligence documentation has been collected and reviewed...';
        }
        else if (type === 'risk') {
            return 'The vendor presents a medium risk profile. Key controls are in place with minor gaps identified and remediation plans established...';
        }
        else {
            return 'Vendor demonstrates compliance with applicable regulatory requirements including GDPR, SOC 2, and industry standards...';
        }
    }
    compareTiers(tier1, tier2) {
        const tierOrder = ['LOW', 'MEDIUM', 'HIGH', 'CRITICAL'];
        const index1 = tierOrder.indexOf(tier1);
        const index2 = tierOrder.indexOf(tier2);
        return index1 < index2 ? 'vendor1' : 'vendor2';
    }
    generateComparisonRecommendation(vendor1, vendor2) {
        if (vendor1.residualRiskScore < vendor2.residualRiskScore) {
            return `${vendor1.name} presents lower overall risk and is recommended for engagement.`;
        }
        else {
            return `${vendor2.name} presents lower overall risk and is recommended for engagement.`;
        }
    }
}
exports.default = new AIVendorIntelligenceService();
//# sourceMappingURL=aiVendorIntelligence.js.map